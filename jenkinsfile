pipeline {
    agent any
    
    tools {
        maven 'Maven-3.9'
    }
    
    environment {
        TOMCAT_URL   = 'http://10.0.1.219:8080'
        TOMCAT_CREDS = 'JENKINS_ID'
        APP_NAME     = 'simple-java-app'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo '========== Checking out Code =========='
                git branch: 'main',
                    url: 'https://github.com/glare247/simple-java-docker.git'
            }
        }
        
        stage('Build') {
            steps {
                echo '========== Building WAR file =========='
                sh 'mvn clean package -DskipTests'
            }
        }
        
        stage('Deploy to Tomcat') {
            steps {
                echo '========== Deploying to Tomcat =========='
                deploy adapters: [
                    tomcat9(
                        credentialsId: env.TOMCAT_CREDS,
                        url: env.TOMCAT_URL
                    )
                ],
                war: "target/${APP_NAME}.war",
                contextPath: "/${APP_NAME}"
            }
        }
        
        stage('Health Check') {
            steps {
                echo '========== Application Health Check =========='
                sh '''
                echo "‚è≥ Waiting for deployment..."
                sleep 25

                STATUS=$(curl -s -L -o /dev/null -w "%{http_code}" ${TOMCAT_URL}/${APP_NAME}/)

                echo "HTTP status: $STATUS"

                if [ "$STATUS" != "200" ] && [ "$STATUS" != "302" ]; then
                    echo "‚ùå Application failed health check"
                    exit 1
                fi

                echo "‚úÖ Application is running successfully"
                '''
            }
        }
    }
    
    post {
        success {
            echo '========================================='
            echo '‚úÖ PIPELINE COMPLETED SUCCESSFULLY!'
            echo '========================================='
            echo "üåê App URL (internal): ${TOMCAT_URL}/${APP_NAME}/"
            echo "üåê App URL (public):  http://34.231.169.236:8080/${APP_NAME}/"
        }
        failure {
            echo '========================================='
            echo '‚ùå PIPELINE FAILED!'
            echo '========================================='
        }
        always {
            cleanWs()
        }
    }
}
