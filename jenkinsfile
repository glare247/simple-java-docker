pipeline {
    agent any
    
    tools {
        maven 'Maven-3.9'
    }
    
    environment {
        TOMCAT_URL = 'http://44.200.37.68:8080'
        TOMCAT_CREDS = 'tomcat-credentials'  
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo '========== Checking out Code =========='
                git branch: 'main',
                    url: 'https://github.com/glare247/simple-java-docker.git'
            }
        }
        
        stage('Build') {
            steps {
                echo '========== Building WAR file =========='
                sh 'mvn clean package'
            }
        }
        
        stage('Test') {
            steps {
                echo '========== Running Tests =========='
                sh 'mvn test'
            }
        }
        
        stage('Deploy to Tomcat') {
            steps {
                echo '========== Deploying to Tomcat Server =========='
                deploy adapters: [
                    tomcat9(
                        credentialsId: "${TOMCAT_CREDS}",
                        url: "${TOMCAT_URL}",
                        path: ''
                    )
                ],
                war: 'target/*.war',
                contextPath: '/simple-java-app'
            }
        }
        
        stage('Health Check') {
            steps {
                echo '========== Checking Application Health =========='
                script {
                    def response = sh(
                        script: "curl -s -o /dev/null -w '%{http_code}' ${TOMCAT_URL}/simple-java-app",
                        returnStdout: true
                    ).trim()
                    
                    if (response == '200') {
                        echo "✅ Application is running successfully!"
                    } else {
                        error "❌ Application health check failed. HTTP Status: ${response}"
                    }
                }
            }
        }
    }
    
    post {
        success {
            echo '========================================='
            echo '✅ PIPELINE COMPLETED SUCCESSFULLY!'
            echo '========================================='
        }
        failure {
            echo '========================================='
            echo '❌ PIPELINE FAILED!'
            echo '========================================='
        }
        always {
            cleanWs()
        }
    }
}