pipeline {
    agent any
    tools {
        maven 'Maven-3.9'
    }
    environment {
        TOMCAT_URL   = 'http://44.192.97.178:8080'
        TOMCAT_CREDS = 'JENKINS_ID'
        APP_NAME     = 'simple-java-app'
    }
    stages {
        stage('Checkout') {
            steps {
                echo '========== Checking out Code =========='
                git branch: 'main',
                    url: 'https://github.com/glare247/simple-java-docker.git'
            }
        }
        stage('Verify Web Application Structure') {
            steps {
                echo '========== Verifying Web Application Structure =========='
                script {
                    sh '''
                    # Verify required directories exist
                    mkdir -p src/main/webapp/WEB-INF
                    
                    # Check if JSP file exists
                    if [ -f src/main/webapp/index.jsp ]; then
                        echo "‚úÖ index.jsp found"
                    else
                        echo "‚ö†Ô∏è  Warning: index.jsp not found"
                    fi
                    
                    # Check if Servlet exists
                    if [ -f src/main/java/com/example/HelloServlet.java ]; then
                        echo "‚úÖ HelloServlet.java found"
                    else
                        echo "‚ö†Ô∏è  Warning: HelloServlet.java not found"
                    fi
                    
                    # Check if web.xml exists
                    if [ -f src/main/webapp/WEB-INF/web.xml ]; then
                        echo "‚úÖ web.xml found"
                    else
                        echo "‚ö†Ô∏è  Warning: web.xml not found"
                    fi
                    
                    echo "‚úÖ Web application structure verified"
                    '''
                }
            }
        }
        stage('Build') {
            steps {
                echo '========== Building WAR file =========='
                sh 'mvn clean package -DskipTests'
            }
        }
        stage('Test') {
            steps {
                echo '========== Running Tests =========='
                sh 'mvn test || true'
            }
        }
        stage('Deploy to Tomcat') {
            steps {
                echo '========== Deploying to Tomcat Server =========='
                script {
                    deploy adapters: [
                        tomcat9(
                            credentialsId: env.TOMCAT_CREDS,
                            url: env.TOMCAT_URL,
                            path: ''
                        )
                    ],
                    war: "target/${APP_NAME}.war",
                    contextPath: "/${APP_NAME}"
                }
            }
        }
        stage('Health Check') {
            steps {
                echo '========== Checking Application Health =========='
                script {
                    sh '''
                    # Wait for Tomcat to fully deploy the application
                    echo "‚è≥ Waiting 10 seconds for deployment to complete..."
                    sleep 10
                    
                    # Check application health
                    STATUS=$(curl -s -L -o /dev/null -w "%{http_code}" ${TOMCAT_URL}/${APP_NAME}/)
                    echo "HTTP status: $STATUS"
                    
                    if [ "$STATUS" = "200" ] || [ "$STATUS" = "302" ]; then
                      echo "‚úÖ Application is running successfully!"
                      echo "üåê Access your app at: ${TOMCAT_URL}/${APP_NAME}/"
                    else
                      echo "‚ùå Application health check failed with status: $STATUS"
                      exit 1
                    fi
                    '''
                }
            }
        }
    }
    post {
        success {
            echo '========================================='
            echo '‚úÖ PIPELINE COMPLETED SUCCESSFULLY!!!'
            echo '========================================='
            echo "üéâ Your application is now live!"
            echo "üìç Main Page: ${TOMCAT_URL}/${APP_NAME}/"
            echo "üìç Servlet Page: ${TOMCAT_URL}/${APP_NAME}/hello"
            echo '========================================='
        }
        failure {
            echo '========================================='
            echo '‚ùå PIPELINE FAILED!'
            echo '========================================='
            echo 'Please check the console output for errors'
        }
        always {
            cleanWs()
        }
    }
}